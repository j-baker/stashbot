// vi: ft=groovy ts=4 sw=4 expandtab

// "borrowed" from
// https://github.com/opscode-cookbooks/jenkins/blob/master/libraries/credentials.rb
// and
// https://github.com/opscode-cookbooks/jenkins/blob/master/libraries/_helper.rb
// and
// https://github.com/opscode-cookbooks/jenkins/blob/master/libraries/credentials_private_key.rb

// import jenkins.model.* // included by default
import com.cloudbees.plugins.credentials.*
import com.cloudbees.plugins.credentials.domains.*
import com.cloudbees.hudson.plugins.folder.properties.FolderCredentialsProvider
import com.cloudbees.hudson.plugins.folder.Folder
import com.cloudbees.jenkins.plugins.sshcredentials.SSHUserPrivateKey
import com.cloudbees.jenkins.plugins.sshcredentials.impl.*


  def get_store(path) {
  	folders = path.replaceAll('/job', '').replaceFirst(/^\//, '').split('/')
 	model = Jenkins.getInstance()
  	store = Jenkins.getInstance().getExtensionList(SystemCredentialsProvider.class)[0].getStore()
  
  for (folder in folders) {
  	model = model.getItemByFullName(folder, Folder.class)
    store = new FolderCredentialsProvider().getStore(model)
  }
  
  return store
  }

private_key = '''$privKey'''
id = '1234'
username = 'git'
pk = new BasicSSHUserPrivateKey.DirectEntryPrivateKeySource(private_key)
passphrase = ""
description = 'Automatically Generated Credentials for Stash User "$user"'

credentials = new BasicSSHUserPrivateKey(CredentialsScope.GLOBAL, id, username, pk, passphrase, description)

get_store("$path").addCredentials(Domain.global(), credentials)

credentials.id